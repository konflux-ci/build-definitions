apiVersion: tekton.dev/v1
kind: Task
metadata:
  labels:
    app.kubernetes.io/version: "0.1"
    build.appstudio.redhat.com/build_type: "docker"
  annotations:
    build.appstudio.redhat.com/expires-on: "2026-01-09T00:00:00Z"
    build.appstudio.redhat.com/expiry-message: "Please update your configuration to use the 'build-image-index' task (version 0.2)."
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/tags: "image-build, konflux"
  name: build-image-index
spec:
  description: |-
    This takes existing Image Manifests and combines them in an Image Index.
  params:
  - name: IMAGE
    description: The target image and tag where the image will be pushed to.
    type: string
  - name: TLSVERIFY
    description: Verify the TLS on the registry endpoint (for push/pull to a non-TLS registry)
    type: string
    default: "true"
  - name: COMMIT_SHA
    description: The commit the image is built from.
    type: string
    default: ""
  - name: IMAGES
    description: List of Image Manifests to be referenced by the Image Index
    type: array
  - name: IMAGE_EXPIRES_AFTER
    description: Delete image tag after specified time resulting in garbage collection of the digest. Empty means to keep the image tag. Time values could be something like 1h, 2d, 3w for hours, days, and weeks, respectively.
    type: string
    default: ""
  - name: ALWAYS_BUILD_INDEX
    description: Build an image index even if IMAGES is of length 1. Default true. If the image index generation is skipped, the task will forward values for params.IMAGES[0] to results.IMAGE_*. In order to properly set all results, use the repository:tag@sha256:digest format for the IMAGES parameter.
    type: string
    default: "true"
  - name: STORAGE_DRIVER
    description: Storage driver to configure for buildah
    type: string
    default: vfs
  - name: BUILDAH_FORMAT
    description: The format for the resulting image's mediaType. Valid values are oci (default) or docker.
    type: string
    default: oci
  - name: SBOM_SKIP_VALIDATION
    description: Flag to enable or disable SBOM validation before save. Validation is optional - use this if you are experiencing performance issues.
    type: string
    default: "false"
  - name: caTrustConfigMapName
    type: string
    description: The name of the ConfigMap to read CA bundle data from
    default: trusted-ca
  - name: caTrustConfigMapKey
    type: string
    description: The name of the key in the ConfigMap that contains the CA bundle data
    default: ca-bundle.crt
  results:
  - description: Digest of the image just built
    name: IMAGE_DIGEST
  - description: Image repository and tag where the built image was pushed
    name: IMAGE_URL
  - description: List of all referenced image manifests
    name: IMAGES
  - description: Image reference of the built image containing both the repository and the digest
    name: IMAGE_REF
  - name: SBOM_BLOB_URL
    description: Reference of SBOM blob digest to enable digest-based verification from provenance
    type: string
  volumes:
    - name: shared-dir
      emptyDir: {}
    - name: trusted-ca
      configMap:
        name: $(params.caTrustConfigMapName)
        items:
          - key: $(params.caTrustConfigMapKey)
            path: ca-bundle.crt
        optional: true

  stepTemplate:
    env:
    - name: BUILDAH_FORMAT
      value: $(params.BUILDAH_FORMAT)
    - name: COMMIT_SHA
      value: $(params.COMMIT_SHA)
    - name: IMAGE
      value: $(params.IMAGE)
    - name: TLSVERIFY
      value: $(params.TLSVERIFY)
    - name: ALWAYS_BUILD_INDEX
      value: $(params.ALWAYS_BUILD_INDEX)
    - name: STORAGE_DRIVER
      value: $(params.STORAGE_DRIVER)
    volumeMounts:
      - name: shared-dir
        mountPath: /index-build-data
      - name: trusted-ca
        mountPath: /mnt/trusted-ca
        readOnly: true
  steps:
  - image: quay.io/konflux-ci/buildah-task:latest@sha256:5c5eb4117983b324f932f144aa2c2df7ed508174928a423d8551c4e11f30fbd9
    # per https://kubernetes.io/docs/concepts/containers/images/#imagepullpolicy-defaulting
    # the cluster will set imagePullPolicy to IfNotPresent
    name: build
    computeResources:
      limits:
        memory: 4Gi
      requests:
        memory: 512Mi
        cpu: 250m
    args: ["$(params.IMAGES[*])"]
    script: |
      #!/bin/bash
      # Fixing group permission on /var/lib/containers
      set -eu
      set -o pipefail
      chown root:root /var/lib/containers

      sed -i 's/^\s*short-name-mode\s*=\s*.*/short-name-mode = "disabled"/' /etc/containers/registries.conf

      echo "[$(date --utc -Ins)] Update CA trust"

      ca_bundle=/mnt/trusted-ca/ca-bundle.crt
      if [ -f "$ca_bundle" ]; then
        echo "INFO: Using mounted CA bundle: $ca_bundle"
        cp -vf $ca_bundle /etc/pki/ca-trust/source/anchors
        update-ca-trust
      fi

      if [[ $# -ne 1 && "$ALWAYS_BUILD_INDEX" != "true" ]]; then
        echo "Skipping image index generation while supplying multiple image inputs is unsupported."
        exit 2
      fi

      buildah manifest create "$IMAGE"
      for i in $@
      do
        TOADD="$i"
        TOADD_URL="$(echo "$i" | cut -d@ -f1)"
        TOADD_DIGEST="$(echo "$i" | cut -d@ -f2)"
        if [[ $(echo "$i" | tr -cd ":" | wc -c) == 2 ]]; then
          #format is repository:tag@sha256:digest
          #we need to remove the tag, and just reference the digest
          #as tag + digest is not supported
          TOADD_REPOSITORY="$(echo "$i" | cut -d: -f1)"
          TOADD="${TOADD_REPOSITORY}@${TOADD_DIGEST}"
        fi
        if [[ "$ALWAYS_BUILD_INDEX" != "true" ]]; then
          echo "Skipping image index generation. Returning results for $TOADD."
          echo -n "${TOADD_URL}" > "$(results.IMAGE_URL.path)"
          echo -n "${TOADD_DIGEST}" > "$(results.IMAGE_DIGEST.path)"
          echo -n "${TOADD}" > "$(results.IMAGES.path)"
          exit 0
        fi
        echo "Adding $TOADD"
        buildah manifest add $IMAGE "docker://$TOADD" --all
      done

      # While the BUILDAH_FORMAT environment variable can define the push
      # format, lets be explicit about the format that we want when we push.
      push_format=oci
      if [ "${BUILDAH_FORMAT}" == "docker" ]; then
        push_format=docker
      fi

      buildah_retries=3

      echo "Pushing image to registry"
      if ! retry buildah manifest push \
        --format="$push_format" \
        --retry "$buildah_retries" \
        --tls-verify="$TLSVERIFY" \
        --digestfile image-digest \
        "$IMAGE" \
        "docker://$IMAGE"
      then
          echo "Failed to push image ${IMAGE} to registry"
          exit 1
      fi

      echo "Pushing image to registry"
      if ! retry buildah manifest push \
        --format="$push_format" \
        --retry "$buildah_retries" \
        --tls-verify="$TLSVERIFY" \
        --digestfile image-digest \
        "$IMAGE" \
        "docker://${IMAGE%:*}:$(context.taskRun.name)"
      then
          echo "Failed to push image ${IMAGE%:*}:$(context.taskRun.name) to registry"
          exit 1
      fi

      # Remove local cache to force remote 'inspect'.
      # When 'buildah push' converts formats (e.g., OCI->Docker), it creates new
      # digests in the registry, but the local cache becomes stale (retains old digests).
      # This ensures we 'inspect' the correct post-conversion digests for SBOMs.
      echo "Removing local manifest list: $IMAGE"
      buildah manifest rm "$IMAGE"

      INDEX_REPOSITORY="$(echo "$IMAGE" | cut -d@ -f1 | cut -d: -f1)"
      PUSHED_INDEX_DIGEST=$(cat image-digest)
      IMMUTABLE_INDEX_REF="${INDEX_REPOSITORY}@${PUSHED_INDEX_DIGEST}"
      INSPECT_FILE="/index-build-data/manifest_data.json"

      echo "Inspecting remote manifest index at: $IMMUTABLE_INDEX_REF"

      if ! retry buildah manifest inspect "$IMMUTABLE_INDEX_REF" > "$INSPECT_FILE"
      then
          echo "Failed to inspect remote manifest index: $IMMUTABLE_INDEX_REF"
          exit 1
      fi

      echo "Successfully inspected remote index, saved to $INSPECT_FILE"

      MANIFEST_DIGESTS=$(jq -er ".manifests[].digest" "$INSPECT_FILE")
      image_manifests=""
      for i in $MANIFEST_DIGESTS
      do
        image_manifests="${image_manifests} ${INDEX_REPOSITORY}@${i},"
      done

      echo -n "$PUSHED_INDEX_DIGEST" | tee "$(results.IMAGE_DIGEST.path)"
      echo -n "$IMAGE" | tee "$(results.IMAGE_URL.path)"
      echo -n "${IMMUTABLE_INDEX_REF}" > "$(results.IMAGE_REF.path)"
      echo -n "${image_manifests:1:-1}" > "$(results.IMAGES.path)"
    securityContext:
      capabilities:
        add:
          - SETFCAP

  - image: quay.io/konflux-ci/mobster:1.1.0-1770046049@sha256:7415f55121f5580ac79dc6e6567383574ee5f94f97736f235a141688f02e6094
    name: create-sbom
    computeResources:
      limits:
        memory: 512Mi
      requests:
        memory: 256Mi
        cpu: 100m
    script: |
      #!/bin/bash
      set -e

      MANIFEST_DATA_FILE="/index-build-data/manifest_data.json"
      if [ ! -f "$MANIFEST_DATA_FILE" ]; then
        echo "The manifest_data.json file does not exist. Skipping the SBOM creation..."
        exit 0
      fi

      IMAGE_URL="$(cat "$(results.IMAGE_URL.path)")"
      IMAGE_DIGEST="$(cat "$(results.IMAGE_DIGEST.path)")"
      echo "Creating SBOM result file..."
      mobster_args=(generate --output /index-build-data/index.spdx.json)

      if [ "${SBOM_SKIP_VALIDATION}" == "true" ]; then
        echo "Skipping SBOM validation"
        mobster_args+=(--skip-validation)
      fi

      mobster_args+=(
        oci-index
        --index-image-pullspec "$IMAGE_URL"
        --index-image-digest "$IMAGE_DIGEST"
        --index-manifest-path "$MANIFEST_DATA_FILE"
      )
      mobster "${mobster_args[@]}"

  - name: upload-sbom
    image: quay.io/konflux-ci/appstudio-utils:latest@sha256:74aadac7ee0ac782216730d6a4736de6da03f9fa51124674329ad717b8141f4c
    script: |
      #!/bin/bash
      set -e

      echo "[$(date --utc -Ins)] Update CA trust"

      ca_bundle=/mnt/trusted-ca/ca-bundle.crt
      if [ -f "$ca_bundle" ]; then
        echo "INFO: Using mounted CA bundle: $ca_bundle"
        cp -vf $ca_bundle /etc/pki/ca-trust/source/anchors
        update-ca-trust
      fi

      SBOM_RESULT_FILE="/index-build-data/index.spdx.json"
      if [ ! -f "$SBOM_RESULT_FILE" ]; then
        echo "The index.spdx.json file does not exists. Skipping the SBOM upload..."
        exit 0
      fi

      # Pre-select the correct credentials to work around cosign not supporting the containers-auth.json spec
      mkdir -p /tmp/auth && select-oci-auth "$(cat "$(results.IMAGE_REF.path)")" > /tmp/auth/config.json
      export DOCKER_CONFIG=/tmp/auth

      echo "Pushing sbom to registry"
      if ! retry cosign attach sbom --sbom "$SBOM_RESULT_FILE" --type spdx "$(cat "$(results.IMAGE_REF.path)")"
      then
          echo "Failed to push sbom to registry"
          exit 1
      fi

      # Remove tag from IMAGE while allowing registry to contain a port number.
      sbom_repo="${IMAGE%:*}"
      sbom_digest="$(sha256sum "$SBOM_RESULT_FILE" | cut -d' ' -f1)"
      # The SBOM_BLOB_URL is created by `cosign attach sbom`.
      echo -n "${sbom_repo}@sha256:${sbom_digest}" | tee "$(results.SBOM_BLOB_URL.path)"
    computeResources:
      limits:
        memory: 512Mi
      requests:
        memory: 256Mi
        cpu: 100m
