apiVersion: tekton.dev/v1
kind: Task
metadata:
  labels:
    app.kubernetes.io/version: "0.1"
    build.appstudio.redhat.com/build_type: "docker"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/tags: "image-build, appstudio, hacbs"
  name: build-image-manifest
spec:
  description: |-
    This takes existing images and stiches them together into a multi platform image.
  params:
  - description: Reference of the image buildah will produce.
    name: IMAGE
    type: string
  - default: "true"
    description: Verify the TLS on the registry endpoint (for push/pull to a non-TLS registry)
    name: TLSVERIFY
    type: string
  - name: COMMIT_SHA
    description: The image is built from this commit.
    type: string
    default: ""
  - name: IMAGES
    description: List of images that are to be merged into the multi platform image
    type: array
  - default: ""
    description: Delete image tag after specified time. Empty means to keep the image tag. Time values could be something like 1h, 2d, 3w for hours, days, and weeks, respectively.
    name: IMAGE_EXPIRES_AFTER
    type: string
  results:
  - description: Digest of the image just built
    name: IMAGE_DIGEST
  - description: Image repository where the built image was pushed
    name: IMAGE_URL
  stepTemplate:
    env:
    - name: BUILDAH_FORMAT
      value: oci
    - name: STORAGE_DRIVER
      value: vfs
    - name: IMAGE
      value: $(params.IMAGE)
    - name: TLSVERIFY
      value: $(params.TLSVERIFY)
  steps:
  - image: quay.io/redhat-appstudio/buildah:v1.31.0@sha256:34f12c7b72ec2c28f1ded0c494b428df4791c909f1f174dd21b8ed6a57cf5ddb
    # per https://kubernetes.io/docs/concepts/containers/images/#imagepullpolicy-defaulting
    # the cluster will set imagePullPolicy to IfNotPresent
    name: build
    computeResources:
      limits:
        memory: 4Gi
      requests:
        memory: 512Mi
        cpu: 250m
    env:
    - name: COMMIT_SHA
      value: $(params.COMMIT_SHA)
    args: ["$(params.IMAGES[*])"]
    script: |
      #!/bin/bash
      # Fixing group permission on /var/lib/containers
      set -eu
      set -o pipefail
      chown root:root /var/lib/containers

      sed -i 's/^\s*short-name-mode\s*=\s*.*/short-name-mode = "disabled"/' /etc/containers/registries.conf

      buildah manifest create "${IMAGE}"

      # collect arguments in two arrays, one containing images with digests and
      # one containing only digests, it is expected that all images without
      # digests are followed with their digests in the same exact order, this
      # aligns with how Tekton results from matrix Tasks are provided, e.g.
      # given args as:
      # - $(tasks.build-container-amd64.results.IMAGE_URL)@$(tasks.build-container-amd64.results.IMAGE_DIGEST)
      # - $(tasks.build-container-multiarch.results.IMAGE_URL[*])
      # - $(tasks.build-container-multiarch.results.IMAGE_DIGEST[*])
      # the substitution should provide the args value as:
      # - registry.io/repository/image-amd64@sha256:...
      # - registry.io/repository/image-arm64
      # - registry.io/repository/image-ppc64le
      # - ...
      # - @sha256:[arm64]
      # - @sha256:[ppc64le]
      # - ...
      # The order is guaranteed because Tekton sorts by TaskRun name before
      # performing the substitution
      images=()
      digests=()
      for i in "$@"; do
        [[ "$i" == @* ]] && digests+=("$i") || images+=("$i")
      done

      declare -i digest_idx=0
      for i in "${images[@]}"; do
        TOADD="${i}"
        # check if the image reference contains both the tag and the digest,
        # making sure that any port in the authority part of the image reference
        # URI is not considered to be part of the tag by looking at the colon
        # present after the slash
        if [[ "${TOADD}" == */*:*@sha*:* ]]; then
          # we need to remove the tag, and just reference the digest
          # as tag + digest is not supported
          # first substitution removes the suffix starting from the last colon
          # before the "@sha*" sequence; the second substitution removes
          # everything up to the "@" character
          TOADD="${TOADD%:*@sha*}@${TOADD#*@}"
        elif [[ ! "${TOADD}" == */*@sha*:* ]]; then
          # the digest was not provided

          # strip the tag if it is present, tag needs to be after the slash
          # character so we do not remove from the port in the authority part of
          # the URI
          if [[ "${TOADD}" == */*:* ]]; then
            TOADD="${TOADD%:*}"
          fi

          # expect the next digest argument to contain the digest for this image
          TOADD="${TOADD}${digests[digest_idx]}"
          digest_idx=$((digest_idx+1))
        fi
        echo "Adding ${TOADD}"
        buildah manifest add "${IMAGE}" "docker://${TOADD}"
      done

      status=-1
      max_run=5
      sleep_sec=10
      for run in $(seq 1 $max_run); do
        status=0
        [ "$run" -gt 1 ] && sleep $sleep_sec
        echo "Pushing image to registry"
        buildah manifest push \
          --tls-verify="${TLSVERIFY}" \
          --digestfile image-digest "${IMAGE}" \
          "docker://${IMAGE}" && break || status=$?
      done
      if [ "$status" -ne 0 ]; then
          echo "Failed to push image to registry after ${max_run} tries"
          exit 1
      fi

      cat image-digest | tee "$(results.IMAGE_DIGEST.path)"
      echo -n "${IMAGE}" | tee "$(results.IMAGE_URL.path)"
    securityContext:
      capabilities:
        add:
          - SETFCAP
