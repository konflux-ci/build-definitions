apiVersion: tekton.dev/v1
kind: Task
metadata:
  labels:
    app.kubernetes.io/version: "0.4"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/tags: "konflux"
  name: init
spec:
  description: >-
    Initialize Pipeline Task, enables configuration for cache-proxy if required during the PipelineRun.
  params:
    - name: enable-cache-proxy
      description: Enable cache proxy configuration
      default: "false"
  results:
    - name: http-proxy
      description: HTTP proxy URL for cache proxy (when enable-cache-proxy is true)
    - name: no-proxy
      description: NO_PROXY value for cache proxy (when enable-cache-proxy is true)
  steps:
    - name: init
      image: quay.io/konflux-ci/konflux-build-cli:b9f6e2350a9af52743c31d6e15c9133cd210e1c3
      computeResources:
        limits:
          memory: 256Mi
          cpu: 100m
        requests:
          memory: 256Mi
          cpu: 100m
      env:
        - name: KBC_LOG_LEVEL
          value: "info"
        - name: DEFAULT_HTTP_PROXY
          value: "squid.caching.svc.cluster.local:3128"
        - name: DEFAULT_NO_PROXY
          value: "brew.registry.redhat.io,docker.io,gcr.io,ghcr.io,images.paas.redhat.com,mirror.gcr.io,nvcr.io,quay.io,registry-proxy.engineering.redhat.com,registry.access.redhat.com,registry.ci.openshift.org,registry.fedoraproject.org,registry.redhat.io,registry.stage.redhat.io,vault.habana.ai"
        - name: HTTP_PROXY_RESULTS_PATH
          value: "$(results.http-proxy.path)"
        - name: NO_PROXY_RESULTS_PATH
          value: "$(results.no-proxy.path)"
      command: ["konflux-build-cli", "config", "cache-proxy"]
      args:
        - --enable
        - "$(params.enable-cache-proxy)"
