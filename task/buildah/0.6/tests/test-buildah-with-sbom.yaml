---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-buildah-with-sbom
spec:
  description: |
    Test the buildah task with SBOM generation enabled
  workspaces:
    - name: tests-workspace
  tasks:
    - name: setup-source
      taskSpec:
        workspaces:
          - name: source
        steps:
          - name: create-dockerfile
            image: quay.io/konflux-ci/appstudio-utils:1610c1fc4cfc9c9053dbefc1146904a4df6659ef@sha256:90ac97b811073cb99a23232c15a08082b586c702b85da6200cf54ef505e3c50c
            script: |
              #!/usr/bin/env bash
              set -euo pipefail

              # Create a simple source directory with a Dockerfile
              mkdir -p "$(workspaces.source.path)"
              cat > "$(workspaces.source.path)/Dockerfile" << 'EOF'
              FROM registry.access.redhat.com/ubi9/ubi-minimal@sha256:d85040b6e3ed3628a89683f51a38c709185efc3fb552db2ad1b9180f2a6c38be
              RUN microdnf install -y findutils && microdnf clean all
              RUN echo "Hello from buildah SBOM test" > /hello.txt
              EOF

              echo "Created Dockerfile:"
              cat "$(workspaces.source.path)/Dockerfile"
      workspaces:
        - name: source
          workspace: tests-workspace
    - name: run-buildah
      taskRef:
        name: buildah
      params:
        - name: IMAGE
          value: registry-service.kind-registry/test-buildah-sbom:latest
        - name: DOCKERFILE
          value: ./Dockerfile
        - name: CONTEXT
          value: .
        - name: HERMETIC
          value: "false"
        - name: SKIP_SBOM_GENERATION
          value: "false"
        - name: SBOM_TYPE
          value: "spdx"
      workspaces:
        - name: source
          workspace: tests-workspace
      runAfter:
        - setup-source
    - name: verify-build
      params:
        - name: IMAGE_DIGEST
          value: $(tasks.run-buildah.results.IMAGE_DIGEST)
        - name: IMAGE_URL
          value: $(tasks.run-buildah.results.IMAGE_URL)
        - name: IMAGE_REF
          value: $(tasks.run-buildah.results.IMAGE_REF)
        - name: SBOM_BLOB_URL
          value: $(tasks.run-buildah.results.SBOM_BLOB_URL)
      taskSpec:
        params:
          - name: IMAGE_DIGEST
          - name: IMAGE_URL
          - name: IMAGE_REF
          - name: SBOM_BLOB_URL
        steps:
          - name: check-image-and-sbom
            env:
              - name: IMAGE_DIGEST
                value: $(params.IMAGE_DIGEST)
              - name: IMAGE_URL
                value: $(params.IMAGE_URL)
              - name: IMAGE_REF
                value: $(params.IMAGE_REF)
              - name: SBOM_BLOB_URL
                value: $(params.SBOM_BLOB_URL)
            image: quay.io/konflux-ci/appstudio-utils:1610c1fc4cfc9c9053dbefc1146904a4df6659ef@sha256:90ac97b811073cb99a23232c15a08082b586c702b85da6200cf54ef505e3c50c
            script: |
              #!/usr/bin/env bash
              set -euo pipefail

              echo "Checking that IMAGE_DIGEST is not empty"
              if [ -z "$IMAGE_DIGEST" ]; then
                echo "ERROR: IMAGE_DIGEST is empty"
                exit 1
              fi
              echo "IMAGE_DIGEST: $IMAGE_DIGEST"

              echo "Checking that IMAGE_URL is not empty"
              if [ -z "$IMAGE_URL" ]; then
                echo "ERROR: IMAGE_URL is empty"
                exit 1
              fi
              echo "IMAGE_URL: $IMAGE_URL"

              echo "Checking that IMAGE_REF is not empty"
              if [ -z "$IMAGE_REF" ]; then
                echo "ERROR: IMAGE_REF is not empty"
                exit 1
              fi
              echo "IMAGE_REF: $IMAGE_REF"

              echo "Checking that SBOM_BLOB_URL is not empty"
              if [ -z "$SBOM_BLOB_URL" ]; then
                echo "ERROR: SBOM_BLOB_URL is empty - SBOM was not generated"
                exit 1
              fi
              echo "SBOM_BLOB_URL: $SBOM_BLOB_URL"

              echo "Verifying SBOM_BLOB_URL format"
              if [[ ! "$SBOM_BLOB_URL" =~ @sha256: ]]; then
                echo "ERROR: SBOM_BLOB_URL does not contain expected digest format"
                exit 1
              fi

              echo "Build with SBOM generation succeeded"
              echo "SBOM was generated and uploaded to: $SBOM_BLOB_URL"
      runAfter:
        - run-buildah
