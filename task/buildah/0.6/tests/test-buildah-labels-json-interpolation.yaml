---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-buildah-labels-json-interpolation
spec:
  description: |
    Test that /root/buildinfo/labels.json contains interpolated label values,
    not template variables like ${VAR}. This reproduces STONEBLD-3924.
  timeouts:
    pipeline: "30m"
  workspaces:
    - name: tests-workspace
  tasks:
    - name: setup-source
      taskSpec:
        workspaces:
          - name: source
        steps:
          - name: create-dockerfile
            image: quay.io/konflux-ci/appstudio-utils:1610c1fc4cfc9c9053dbefc1146904a4df6659ef@sha256:90ac97b811073cb99a23232c15a08082b586c702b85da6200cf54ef505e3c50c
            script: |
              #!/usr/bin/env bash
              set -euo pipefail

              # Create a Dockerfile with labels using ARG template variables
              mkdir -p "$(workspaces.source.path)"
              cat > "$(workspaces.source.path)/Dockerfile" << 'EOF'
              FROM registry.access.redhat.com/ubi9/ubi-minimal@sha256:d85040b6e3ed3628a89683f51a38c709185efc3fb552db2ad1b9180f2a6c38be
              ARG RELEASE_VERSION=v1.2.3
              ARG COMMIT_SHA=abc123def456
              ARG SOURCE_URL=https://github.com/example/repo
              LABEL version="${RELEASE_VERSION}"
              LABEL release="${RELEASE_VERSION}"
              LABEL io.openshift.build.commit.id="${COMMIT_SHA}"
              LABEL io.openshift.build.source-location="${SOURCE_URL}"
              LABEL io.openshift.build.commit.url="${SOURCE_URL}/commit/${COMMIT_SHA}"
              RUN echo "Test image" > /test.txt
              EOF

              echo "Created Dockerfile with template variable labels:"
              cat "$(workspaces.source.path)/Dockerfile"
      workspaces:
        - name: source
          workspace: tests-workspace
    - name: run-buildah
      taskRef:
        name: buildah
      params:
        - name: IMAGE
          value: registry-service.kind-registry/test-labels-json:latest
        - name: DOCKERFILE
          value: ./Dockerfile
        - name: CONTEXT
          value: .
        - name: HERMETIC
          value: "false"
        - name: SKIP_SBOM_GENERATION
          value: "true"
      workspaces:
        - name: source
          workspace: tests-workspace
      runAfter:
        - setup-source
    - name: verify-labels-json
      params:
        - name: IMAGE_DIGEST
          value: $(tasks.run-buildah.results.IMAGE_DIGEST)
        - name: IMAGE_URL
          value: $(tasks.run-buildah.results.IMAGE_URL)
      taskSpec:
        params:
          - name: IMAGE_DIGEST
          - name: IMAGE_URL
        steps:
          - name: check-labels-json-contents
            env:
              - name: IMAGE_DIGEST
                value: $(params.IMAGE_DIGEST)
              - name: IMAGE_URL
                value: $(params.IMAGE_URL)
            image: quay.io/konflux-ci/appstudio-utils:1610c1fc4cfc9c9053dbefc1146904a4df6659ef@sha256:90ac97b811073cb99a23232c15a08082b586c702b85da6200cf54ef505e3c50c
            script: |
              #!/usr/bin/env bash
              set -euo pipefail

              REGISTRY_REPO="${IMAGE_URL%:*}"
              IMAGE_REF="${REGISTRY_REPO}@${IMAGE_DIGEST}"

              echo "Verifying layer count is 3 (2 base + 1 combined new layer)"
              layer_count=$(skopeo inspect --tls-verify=false "docker://${IMAGE_REF}" | jq '.Layers | length')
              echo "Image has $layer_count layers"

              if [ "$layer_count" -ne 3 ]; then
                echo "ERROR: Expected exactly 3 layers, got $layer_count"
                echo "Layer count should not change for STONEBLD-3924 fix"
                exit 1
              fi

              echo "Getting actual image labels"
              actual_labels=$(skopeo inspect --tls-verify=false "docker://${IMAGE_REF}" | jq '.Labels')
              echo "Actual image labels:"
              echo "$actual_labels" | jq .

              echo "Copying image to OCI format for extraction"
              skopeo copy --src-tls-verify=false "docker://${IMAGE_REF}" "oci:/tmp/image-oci:latest"

              echo "Extracting labels.json from image layers"
              layer_digests=$(skopeo inspect --tls-verify=false "docker://${IMAGE_REF}" | jq -r '.Layers[]')

              found=false
              for digest in $layer_digests; do
                echo "Checking layer: $digest"
                mkdir -p /tmp/layer-extract
                cd /tmp/layer-extract
                rm -rf ./*

                layer_sha=$(echo "$digest" | cut -d: -f2)
                if [ -f "/tmp/image-oci/blobs/sha256/$layer_sha" ]; then
                  tar -xzf "/tmp/image-oci/blobs/sha256/$layer_sha" 2>/dev/null || tar -xf "/tmp/image-oci/blobs/sha256/$layer_sha" 2>/dev/null || true
                  if [ -f root/buildinfo/labels.json ]; then
                    echo "Found labels.json in layer $digest"
                    cp root/buildinfo/labels.json /tmp/labels.json
                    found=true
                    break
                  fi
                fi
              done

              if [ "$found" != "true" ]; then
                echo "ERROR: Could not find /root/buildinfo/labels.json in any layer"
                exit 1
              fi

              echo "Contents of /root/buildinfo/labels.json from image:"
              jq . /tmp/labels.json

              echo "Checking for un-interpolated template variables"
              if grep -q "\${" /tmp/labels.json; then
                echo "ERROR: labels.json contains un-interpolated template variables:"
                grep "\${" /tmp/labels.json
                echo ""
                echo "This is STONEBLD-3924 - labels.json should have interpolated values"
                exit 1
              fi

              echo "Verifying labels.json matches actual image labels"
              labels_json_content=$(cat /tmp/labels.json)

              version_in_file=$(echo "$labels_json_content" | jq -r '.version')
              version_in_image=$(echo "$actual_labels" | jq -r '.version')

              if [ "$version_in_file" != "$version_in_image" ]; then
                echo "ERROR: version label mismatch"
                echo "  In labels.json: $version_in_file"
                echo "  In image: $version_in_image"
                exit 1
              fi

              commit_id_in_file=$(echo "$labels_json_content" | jq -r '."io.openshift.build.commit.id"')
              commit_id_in_image=$(echo "$actual_labels" | jq -r '."io.openshift.build.commit.id"')

              if [ "$commit_id_in_file" != "$commit_id_in_image" ]; then
                echo "ERROR: commit.id label mismatch"
                echo "  In labels.json: $commit_id_in_file"
                echo "  In image: $commit_id_in_image"
                exit 1
              fi

              echo "SUCCESS: labels.json has 3 layers and contains interpolated values matching image labels"
      runAfter:
        - run-buildah
