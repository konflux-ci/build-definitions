---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: push-dockerfile-oci-ta
  annotations:
    tekton.dev/pipelines.minVersion: 0.12.1
    tekton.dev/tags: image-build, appstudio
  labels:
    app.kubernetes.io/version: "0.2"
    build.appstudio.redhat.com/build_type: docker
spec:
  description: Discover Dockerfile from source code and push it to registry
    as an OCI artifact.
  params:
    - name: ARTIFACT_TYPE
      description: Artifact type of the Dockerfile image.
      type: string
      default: application/vnd.konflux.dockerfile
    - name: CA_TRUST_CONFIG_MAP_KEY
      description: The name of the key in the ConfigMap that contains the
        CA bundle data.
      type: string
      default: ca-bundle.crt
    - name: CA_TRUST_CONFIG_MAP_NAME
      description: The name of the ConfigMap to read CA bundle data from.
      type: string
      default: trusted-ca
    - name: CONTEXT
      description: Path to the directory to use as context.
      type: string
      default: .
    - name: DOCKERFILE
      description: Path to the Dockerfile.
      type: string
      default: ./Dockerfile
    - name: IMAGE
      description: The built binary image. The Dockerfile is pushed to the
        same image repository alongside.
      type: string
    - name: IMAGE_DIGEST
      description: The built binary image digest, which is used to construct
        the tag of Dockerfile image.
      type: string
    - name: LOG_LEVEL
      description: Log level to use in the task. See golang logrus docs for
        available levels.
      type: string
      default: info
    - name: SOURCE_ARTIFACT
      description: The Trusted Artifact URI pointing to the artifact with
        the application source code.
      type: string
    - name: TAG_SUFFIX
      description: Suffix of the Dockerfile image tag.
      type: string
      default: .dockerfile
  results:
    - name: IMAGE_REF
      description: Digest-pinned image reference to the Dockerfile image.
  volumes:
    - name: trusted-ca
      configMap:
        items:
          - key: $(params.CA_TRUST_CONFIG_MAP_KEY)
            path: ca-bundle.crt
        name: $(params.CA_TRUST_CONFIG_MAP_NAME)
        optional: true
    - name: workdir
      emptyDir: {}
  stepTemplate:
    volumeMounts:
      - mountPath: /etc/pki/tls/certs/ca-custom-bundle.crt
        name: trusted-ca
        readOnly: true
        subPath: ca-bundle.crt
      - mountPath: /var/workdir
        name: workdir
  steps:
    - name: use-trusted-artifact
      image: quay.io/konflux-ci/build-trusted-artifacts:latest@sha256:15d7dc86012e41b10d1eb37679ec03ee75c96436224fadd0938a49dc537aa4ad
      args:
        - use
        - $(params.SOURCE_ARTIFACT)=/var/workdir/source
    - name: push
      image: quay.io/konflux-ci/konflux-build-cli@sha256:cbac25972803b3349737b042a9e22da7d748e3bcf98a737baf702b43e0ce0dae
      command:
        - konflux-build-cli
        - image
        - push-containerfile
      args:
        - --source
        - source
        - --context
        - $(params.CONTEXT)
        - --dockerfile
        - $(params.DOCKERFILE)
        - --image-url
        - $(params.IMAGE)
        - --image-digest
        - $(params.IMAGE_DIGEST)
        - --artifact-type
        - $(params.ARTIFACT_TYPE)
        - --tag-suffix
        - $(params.TAG_SUFFIX)
        - --result-path-image-ref
        - $(results.IMAGE_REF.path)
      workingDir: /var/workdir
      env:
        - name: KBC_LOG_LEVEL
          value: $(params.LOG_LEVEL)
      computeResources:
        limits:
          memory: 256Mi
        requests:
          cpu: 100m
          memory: 256Mi
