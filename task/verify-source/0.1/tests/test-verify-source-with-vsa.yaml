---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-verify-source-with-vsa
spec:
  description: |
    Test the verify-source task with SLSA source verification
  tasks:
    - name: run-task
      taskRef:
        name: verify-source
      params:
        - name: url
          value: https://github.com/slsa-framework/source-tool
        - name: revision
          value: 134593d9158efd253e979e2e8d87b939945d091e
    - name: check-result
      params:
        - name: SLSA_SOURCE_LEVEL_ACHIEVED
          value: $(tasks.run-task.results.SLSA_SOURCE_LEVEL_ACHIEVED)
        - name: TEST_OUTPUT
          value: $(tasks.run-task.results.TEST_OUTPUT)
      taskSpec:
        params:
          - name: SLSA_SOURCE_LEVEL_ACHIEVED
          - name: TEST_OUTPUT
        steps:
          - name: check-result
            env:
              - name: SLSA_LEVEL_ACHIEVED
                value: $(params.SLSA_SOURCE_LEVEL_ACHIEVED)
              - name: TEST_OUTPUT
                value: $(params.TEST_OUTPUT)
            image: quay.io/konflux-ci/appstudio-utils:1610c1fc4cfc9c9053dbefc1146904a4df6659ef@sha256:90ac97b811073cb99a23232c15a08082b586c702b85da6200cf54ef505e3c50c
            script: |
              #!/usr/bin/env sh
              set -eux

              # Strip trailing newlines from results
              LEVEL=$(echo "$SLSA_LEVEL_ACHIEVED" | tr -d '\n')
              OUTPUT=$(echo "$TEST_OUTPUT" | tr -d '\n')

              echo "SLSA_SOURCE_LEVEL_ACHIEVED: $LEVEL"
              echo "TEST_OUTPUT: $OUTPUT"

              # Verify that SLSA level is 3 (extracted from VSA)
              if [ "$LEVEL" != "SLSA_SOURCE_LEVEL_3" ]; then
                echo "ERROR: Expected SLSA_SOURCE_LEVEL_3 from slsa-framework/source-tool repo VSA, got: $LEVEL"
                exit 1
              fi

              # Verify that TEST_OUTPUT is non-empty
              if [ -z "$OUTPUT" ]; then
                echo "ERROR: TEST_OUTPUT is empty"
                exit 1
              fi

              echo "SUCCESS: SLSA verification test passed"
      runAfter:
        - run-task
