---
- op: replace
  path: /metadata/name
  value: tekton-bundle-builder
- op: replace
  path: /spec/tasks/3/taskRef
  value:
    name: tkn-bundle
    version: "0.2"
# Use the template-build as a template replacing the Pipeline name and the
# `build-container` step's task reference
# Order of Tasks from the base template:
#  yq ".spec.tasks.[].name" pipelines/template-build/template-build.yaml | nl -v 0
#      0  init
#      1  clone-repository
#      2  prefetch-dependencies
#      3  build-container
#      4  build-image-index
#      5  build-source-image
#      6  deprecated-base-image-check
#      7  clair-scan
#      8  ecosystem-cert-preflight-checks
#      9  sast-snyk-check
#     10  clamav-scan
#     11  sast-coverity-check
#     12  coverity-availability-check
#     13  sast-shell-check
#     14  sast-unicode-check
#     15  apply-tags
#     16  push-dockerfile
#     17  rpms-signature-scan
- op: add
  path: /spec/tasks/3/params
  value:
  - name: IMAGE
    value: $(params.output-image)
  - name: CONTEXT
    value: $(params.path-context)
  - name: URL
    value: $(params.git-url)
  - name: REVISION
    value: $(params.revision)
# Remove tasks that assume a binary image
- op: remove
  path: /spec/tasks/17  # rpms-signature-scan
- op: remove
  path: /spec/tasks/16  # push-dockerfile
- op: remove
  path: /spec/tasks/12  # coverity-availability-check
- op: remove
  path: /spec/tasks/11  # sast-coverity-check
- op: remove
  path: /spec/tasks/10  # clamav-scan
- op: remove
  path: /spec/tasks/9   # sast-snyk-check
- op: remove
  path: /spec/tasks/8   # ecosystem-cert-preflight-checks
- op: remove
  path: /spec/tasks/7   # clair-scan
- op: remove
  path: /spec/tasks/6   # deprecated-base-image-check
- op: remove
  path: /spec/tasks/5   # build-source-image

# Remove buildah format, it's not applicable for tekton-bundles
# $ kustomize build pipelines/template-build/ | yq ".spec.params.[].name" | nl -v 0
#  0	git-url
#  1	revision
#  2	output-image
#  3	path-context
#  4	dockerfile
#  5	skip-checks
#  6	hermetic
#  7	prefetch-input
#  8	image-expires-after
#  9	build-source-image
# 10	build-image-index
# 11	buildah-format
# 12	enable-cache-proxy
- op: remove
  path: /spec/params/11  # buildah-format
# Remove build-index-image task params
# $ yq ".spec.tasks.4.params.[].name" pipelines/template-build/template-build.yaml | nl -v 0
#      0	IMAGE
#      1	COMMIT_SHA
#      2	IMAGE_EXPIRES_AFTER
#      3	ALWAYS_BUILD_INDEX
#      4	IMAGES
#      5	BUILDAH_FORMAT
- op: remove
  path: /spec/tasks/4/params/5  # BUILDAH_FORMAT
