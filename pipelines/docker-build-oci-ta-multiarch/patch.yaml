---
- op: replace
  path: /metadata/name
  value: docker-build-oci-ta-multiarch
# task3 is build-container
- op: replace
  path: /spec/tasks/3/params
  value:
    - name: IMAGE
      value: $(params.output-image)
    - name: COMMIT_SHA
      value: $(tasks.clone-repository.results.commit)
    - name: IMAGES
      value:
      - $(tasks.build-container-amd64.results.IMAGE_URL)@$(tasks.build-container-amd64.results.IMAGE_DIGEST)
      - $(tasks.build-container-arm64.results.IMAGE_URL)@$(tasks.build-container-arm64.results.IMAGE_DIGEST)
      - $(tasks.build-container-s390x.results.IMAGE_URL)@$(tasks.build-container-s390x.results.IMAGE_DIGEST)
      - $(tasks.build-container-ppc64le.results.IMAGE_URL)@$(tasks.build-container-ppc64le.results.IMAGE_DIGEST)
- op: replace
  path: /spec/tasks/3/runAfter
  value:
  - build-container-amd64
  - build-container-arm64
  - build-container-s390x
  - build-container-ppc64le
- op: replace
  path: /spec/tasks/3/taskRef/name
  value: build-image-manifest
- op: replace
  path: /spec/finally/0/params/0/value
  value: $(tasks.build-container-amd64.results.IMAGE_URL)
- op: replace 
  path: /spec/results/4/value
  value: $(tasks.build-container-amd64.results.JAVA_COMMUNITY_DEPENDENCIES)
- op: add  
  path: /spec/tasks/4/params/-
  value:
    name: BASE_IMAGES
    value: $(tasks.build-container-amd64.results.BASE_IMAGES_DIGESTS)
- op: replace  
  path: /spec/tasks/5/params
  value:   
  - name: BASE_IMAGES_DIGESTS
    value: $(tasks.build-container-amd64.results.BASE_IMAGES_DIGESTS)
  - name: IMAGE_URL
    value: $(tasks.build-container-amd64.results.IMAGE_URL)
  - name: IMAGE_DIGEST
    value: $(tasks.build-container-amd64.results.IMAGE_DIGEST)
- op: add
  path: /spec/tasks/-
  value:
    name: build-container-amd64
    params:
      - name: IMAGE
        value: $(params.output-image)-amd64
      - name: DOCKERFILE
        value: $(params.dockerfile)
      - name: CONTEXT
        value: $(params.path-context)
      - name: HERMETIC
        value: $(params.hermetic)
      - name: PREFETCH_INPUT
        value: $(params.prefetch-input)
      - name: IMAGE_EXPIRES_AFTER
        value: $(params.image-expires-after)
      - name: COMMIT_SHA
        value: $(tasks.clone-repository.results.commit)
      - name: BUILD_ARGS_FILE
        value: $(params.build-args-file)
      - name: SOURCE_ARTIFACT
        value: $(tasks.prefetch-dependencies.results.SOURCE_ARTIFACT)
      - name: CACHI2_ARTIFACT
        value: $(tasks.prefetch-dependencies.results.CACHI2_ARTIFACT)
    runAfter:
      - prefetch-dependencies
    taskRef:
      name: buildah-oci-ta
      version: "0.2"
    when:
      - input: $(tasks.init.results.build)
        operator: in
        values:
          - "true"
- op: add
  path: /spec/tasks/-
  value:
    name: build-container-arm64
    params:
      - name: IMAGE
        value: $(params.output-image)-arm64
      - name: DOCKERFILE
        value: $(params.dockerfile)
      - name: CONTEXT
        value: $(params.path-context)
      - name: HERMETIC
        value: $(params.hermetic)
      - name: PREFETCH_INPUT
        value: $(params.prefetch-input)
      - name: IMAGE_EXPIRES_AFTER
        value: $(params.image-expires-after)
      - name: COMMIT_SHA
        value: $(tasks.clone-repository.results.commit)
      - name: BUILD_ARGS_FILE
        value: $(params.build-args-file)
      - name: SOURCE_ARTIFACT
        value: $(tasks.prefetch-dependencies.results.SOURCE_ARTIFACT)
      - name: CACHI2_ARTIFACT
        value: $(tasks.prefetch-dependencies.results.CACHI2_ARTIFACT)
      - name: PLATFORM
        value: linux/arm64
    runAfter:
      - prefetch-dependencies
    taskRef:
      name: buildah-remote-oci-ta
      version: "0.2"
    when:
      - input: $(tasks.init.results.build)
        operator: in
        values:
          - "true"
- op: add
  path: /spec/tasks/-
  value:
    name: build-container-ppc64le
    params:
      - name: IMAGE
        value: $(params.output-image)-ppc64le
      - name: DOCKERFILE
        value: $(params.dockerfile)
      - name: CONTEXT
        value: $(params.path-context)
      - name: HERMETIC
        value: $(params.hermetic)
      - name: PREFETCH_INPUT
        value: $(params.prefetch-input)
      - name: IMAGE_EXPIRES_AFTER
        value: $(params.image-expires-after)
      - name: COMMIT_SHA
        value: $(tasks.clone-repository.results.commit)
      - name: BUILD_ARGS_FILE
        value: $(params.build-args-file)
      - name: SOURCE_ARTIFACT
        value: $(tasks.prefetch-dependencies.results.SOURCE_ARTIFACT)
      - name: CACHI2_ARTIFACT
        value: $(tasks.prefetch-dependencies.results.CACHI2_ARTIFACT)
      - name: PLATFORM
        value: linux/ppc64le
    runAfter:
      - prefetch-dependencies
    taskRef:
      name: buildah-remote-oci-ta
      version: "0.2"
    when:
      - input: $(tasks.init.results.build)
        operator: in
        values:
          - "true"
- op: add
  path: /spec/tasks/-
  value:
    name: build-container-s390x
    params:
      - name: IMAGE
        value: $(params.output-image)-s390x
      - name: DOCKERFILE
        value: $(params.dockerfile)
      - name: CONTEXT
        value: $(params.path-context)
      - name: HERMETIC
        value: $(params.hermetic)
      - name: PREFETCH_INPUT
        value: $(params.prefetch-input)
      - name: IMAGE_EXPIRES_AFTER
        value: $(params.image-expires-after)
      - name: COMMIT_SHA
        value: $(tasks.clone-repository.results.commit)
      - name: BUILD_ARGS_FILE
        value: $(params.build-args-file)
      - name: SOURCE_ARTIFACT
        value: $(tasks.prefetch-dependencies.results.SOURCE_ARTIFACT)
      - name: CACHI2_ARTIFACT
        value: $(tasks.prefetch-dependencies.results.CACHI2_ARTIFACT)
      - name: PLATFORM
        value: linux/s390x
    runAfter:
      - prefetch-dependencies
    taskRef:
      name: buildah-remote-oci-ta
      version: "0.2"
    when:
      - input: $(tasks.init.results.build)
        operator: in
        values:
          - "true"
