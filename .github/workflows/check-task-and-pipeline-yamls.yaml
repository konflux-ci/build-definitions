name: Check Tasks and Pipelines YAMLs

"on":
  pull_request:
    branches: [main]
  merge_group:
    types: [checks_requested]

jobs:
  check:
    runs-on: ubuntu-24.04

    steps:
      - name: Hit the GH API rate limit
        run: |
          #!/bin/bash
          set -euo pipefail

          for i in {1..61}; do
            printf "Request %d: " "$i"
            curl --fail-with-body --silent --show-error https://api.github.com/repos/tektoncd/cli/releases/latest |
              jq 'if .assets then .assets[0].browser_download_url else . end' -r
          done
        continue-on-error: true

      - name: Don't hit the GH API rate limit
        run: |
          #!/bin/bash
          set -euo pipefail

          headers=()
          if [[ -n "${GITHUB_TOKEN:-}" ]]; then
            echo "Using GITHUB_TOKEN"
            headers+=(--header "Authorization: Bearer ${GITHUB_TOKEN}")
          fi

          for i in {1..61}; do
            printf "Request %d: " "$i"
            curl --fail-with-body --silent --show-error "${headers[@]}" https://api.github.com/repos/tektoncd/cli/releases/latest |
              jq 'if .assets then .assets[0].browser_download_url else . end' -r
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
